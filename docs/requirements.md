# 要件定義書（初版）

**プロダクト名**：AI チャットボットプラットフォーム（Takasho Site Assistant）
**想定リリース**：MVP 2–4 週
**採用技術**：Next.js、Vercel AI SDK（AI SDK）、OpenAI API、Perplexity API

---

## 1. 背景・目的

- **目的**

  - タカショー関連サイト群の**回遊性向上**（ページ/セッション、滞在時間、離脱率改善）
  - グループ各サイトの**横断連携**（適切サイトへ誘導・引用）
  - ユーザーの質問に対し**根拠リンク付き**で正確・迅速に回答

- **達成指標（KPI）**

  - クリック率（回答内引用リンクの CTR）≥ 8%
  - サイト内検索離脱率の 10%改善
  - 回答満足度（5 段階）平均 4.2 以上
  - 管理画面で回答不能タグ（「未解決」）率を週次で 20%→10%へ

---

## 2. スコープ

- **プラットフォーム単体モード**：全質問に対して**登録済み全サイト**から横断検索・回答
- **埋め込みウィジェットモード**：

  1. まず**埋め込み先サイト**内を検索 →
  2. 見つからなければ**登録サイト横断**へフェイルオーバー

- **マルチモーダル**：画像入力（例：製品写真 → 該当ページ候補提示）
- **チャット文脈保持**：会話履歴に基づき追質問へ自然応答
- **QA 候補生成**：初回の質問候補と、回答後の「次に聞くこと」候補を自動生成
- **回答ストリーミング**：逐次表示
- **管理画面**：問い合わせログの一覧・詳細・検索・エクスポート

> **除外（初版）**：FAQ 自動同期 CMS、音声入出力、ログイン会員連携、決済。

---

## 3. 利用者とユースケース

- **一般ユーザー**：製品仕様、施工例、価格レンジ、取扱店、サポート情報の検索
- **営業/サポート**：該当ページの即時提示、リンク共有
- **Web 運用担当（管理者）**：未解決質問の把握、コンテンツ改善指示、サイト追加

**主なユースケース**

1. 製品名で検索 → 該当製品ページ・仕様 PDF・事例記事を根拠リンク付き提示
2. 画像アップ → 類似製品/材質推定と関連ページ候補を提示
3. ウィジェットでサイト内検索 → 無ければ横断 → 最適サイトへ誘導
4. 回答後に**次の質問候補**（例：「設置事例を見る」「メンテ方法」）を提示

---

## 4. 機能要件

### 4.1 検索・回答

- **対象サイト管理**：管理画面で「サイト名、ドメイン、ロール（公式/製品/施工事例/サポート）、優先度、サイトマップ URL」を登録・更新
- **サイト選定ロジック**

  - プラットフォーム：**全サイト**を候補化
  - ウィジェット：**埋め込み先サイト**→ 未ヒット時に**横断**
  - 意図分類（製品/事例/サポート/会社情報/ニュース）で**サイト優先度**を重み付け

- **検索手段**

  - Perplexity API：最新 Web 検索＋要約（高精度）
  - 併用方針：まず Perplexity で候補 URL 回収 → 必要に応じてページ本文の再抽出（サマリ生成）

- **回答生成（OpenAI）**

  - 指示：**必ず引用リンクを併記**し、出典ごとに短い根拠要約を付与
  - チャット履歴コンテキストを投入（会話 ID 単位）
  - **ストリーミング**表示（AI SDK の Stream 対応）

- **画像入力**

  - 受け付け形式：.jpg/.png（最大 5MB）
  - 画像 → テキスト記述抽出（例：ラベル、形状、素材）→ 検索クエリへ拡張
  - 個人情報/著作権配慮の警告・フィルタ

### 4.2 QA 候補生成

- **初回候補**：サイト属性に応じて 3–5 件（例：製品比較、事例、施工ガイド）
- **次の質問**：回答コンテンツに基づき 3 件自動生成（深掘り/横展開/CTA 誘導）

### 4.3 ウィジェット

- **設置方式**：1 行スニペット（script タグ）
- **ブランド適用**：ロゴ・カラー・角丸・文言をサイト側で上書き可（data-属性）
- **動作**：ページ URL・ドメインを自動検知し「サイト内優先」モードに切替

### 4.4 管理画面（Admin）

- **認証**：管理者ログイン（SaaS 管理用・社内 SSO は将来拡張）
- **一覧**：質問文、回答要約、参照リンク、満足度（任意評価）、タグ（意図/製品/カテゴリ）、時刻、モード（プラットフォーム/ウィジェット）、ドメイン
- **検索・絞込**：期間、サイト、タグ、未解決フラグ
- **詳細**：会話タイムライン、プロンプト/システムコンテキスト、呼び出し API ログ（コスト概算）
- **エクスポート**：CSV/JSON
- **サイト設定**：対象サイトの追加/編集、優先度、クロール除外設定、QA 候補テンプレ

### 4.5 品質・安全

- **ハルシネーション抑制**：根拠リンクの無い断定的表現は禁止。出典が弱い場合は「未確定」表現に変更
- **コンテンツポリシー**：不適切コンテンツの検出・遮断（OpenAI モデレーション）
- **リーガル**：著作権／商標表記に注意書き。スクレイピング規約順守（robots.txt 尊重）

---

## 5. 非機能要件

- **パフォーマンス**

  - 95 パーセンタイル応答開始 < 2.5s（キャッシュヒット時 < 1.0s）
  - ストリーミング初速重視（先頭 100 文字以内を 1.2s 以内）

- **可用性**：稼働率 99.5%（API 依存のため計画停止除外）
- **拡張性**：サイト数 100 ドメイン、月間 10 万セッション想定
- **セキュリティ**

  - API キーはサーバー側保護（Edge Config/環境変数）
  - 画像は一時保管（署名付き URL、24h で消去）
  - PII 最小化、IP レート制限、Bot 検知

- **プライバシー**

  - ログの保存期間：
  - 匿名化（IP ハッシュ、User-Agent のみ保存）

- **アクセシビリティ**：WCAG 2.1 AA 準拠（キーボード操作、SR 対応）
- **多言語**：UI 日本語/英語（回答は日本語優先）

---

## 6. システム構成（論理）

- **フロント**（Next.js）

  - プラットフォーム UI、ウィジェット埋め込み、ストリーミング表示、画像アップロード

- **API 層**（Next.js API Routes / Edge Functions）

  - ルーティング：意図分類 → サイト優先度決定 → 検索クエリ生成
  - Perplexity API 呼び出し → 候補 URL と要約取得
  - 必要に応じ HTML 取得/要約（軽量抽出）
  - OpenAI で最終回答組立（**引用リンク必須**のシステムプロンプト）
  - レスポンスを AI SDK でストリーム返却

- **データ**

  - 会話/質問ログ、参照 URL、評価、タグ、画像メタ
  - サイト設定（ドメイン、優先度、カテゴリ、状態）

- **管理画面**

  - 認証、ログ閲覧、サイト設定、CSV 出力

- **監視**

  - 失敗率、タイムアウト、外部 API コスト/レイテンシ、人気質問ランキング

---

## 7. 外部 API と制約

- **Perplexity API**：Web 検索・要約。リクエスト上限、料金を考慮して**キャッシュ**必須
- **OpenAI API**：テキスト生成＋画像理解（Vision 入力）。**出典明記**を強制するプロンプトガード
- **Vercel AI SDK**：ストリーミング（Server/Edge）、ツール呼び出し制御

---

## 8. データモデル（概略）

- `Conversations`：id, mode(platform|widget), domain, startedAt, userLocale
- `Messages`：id, conversationId, role(user|assistant|system), content, imageRef?, createdAt
- `Citations`：id, messageId, url, title, siteTag(product|case|support|corp|news), snippet, rank
- `Sites`：id, name, domain, priority(int), category, sitemapUrl?, crawlAllowed(bool), status
- `Intents`：id, name（product/case/support/corp/news）, patterns, sitePriorityOverrides(json)

---

## 9. フロー（要約）

### 9.1 プラットフォームモード

1. 質問受付（テキスト/画像）
2. 意図分類 → キーワード抽出
3. サイト優先度合成（全サイト対象）
4. Perplexity 検索 → 候補 URL + 要約
5. ページ要約補完（必要時）
6. OpenAI で回答生成（**引用リンク必須**）→ ストリーミング返却
7. 次の質問候補生成 → 表示

### 9.2 ウィジェットモード

1. 埋め込み先ドメイン検知 → そのサイトを**第一優先**で検索
2. 未ヒット → 登録サイト**横断**
3. 以降はプラットフォーム同様

---

## 10. 画面要件（概要）

### 10.1 プラットフォーム UI

- 入力エリア（テキスト/画像ドロップ）
- 提示：回答本文（逐次）、**出典リンク**（ドメイン名＋タイトル＋抜粋）
- 「次に聞くこと」3 件、クリアボタン、フィードバック（👍/👎 ＋コメント）

### 10.2 ウィジェット

- 浮遊ボタン → ドロワーチャット
- サイトテーマ適用、設置 1 行スニペット、data 属性で外観調整

### 10.3 管理画面

- 一覧（テーブル：質問、要約、リンク数、評価、日時、ドメイン、モード）
- 詳細（会話タイムライン、使用プロンプト、API コール概要、コスト見積）
- サイト管理（CRUD、優先度、カテゴリ、クロール可否）

---

## 11. プロンプト方針（要約）

- **システム**：

  - 「根拠リンクの無い断定を禁止」「出典は箇条書きで URL と要約を付与」「製品名の曖昧一致は候補提示」
  - 「不確実時は明確に不確実と表現し、確認方法・問い合わせ先を提案」

- **ユーザー**：自然文
- **ツール**：`search_web`, `fetch_page`, `summarize`, `answer_with_citations`

---

## 12. キャッシュ・コスト最適化

- 質問クエリの正規化キーで**Perplexity 結果を TTL 12–24h**キャッシュ
- 同一 URL の要約もハッシュキーでキャッシュ
- ホット質問は**回答丸ごと**を短期キャッシュ（ただし会話文脈差分に注意）

---

## 13. エラーハンドリング

- API 失敗：代替経路（Perplexity 失敗 → 既存要約 DB のみ、OpenAI 失敗 →「要約のみ＋リンク列挙」）
- 出典不足：警告文＋質問の言い換え候補提示
- 画像 NG：形式・サイズ・権利警告、テキスト入力へのフォールバック
- レート超過：待機 UI と再試行ガイド、管理者通知

---

## 14. セキュリティ・法務

- robots.txt 順守、noindex 領域のクロール回避
- 個人情報入力のガイダンス（住所/電話/メールの取り扱い注意）
- ログは IP ハッシュ化、GDPR/改正個人情報保護法の開示・削除依頼に対応

---

## 15. 設置・運用

- **デプロイ**：AWS、監視（Log/Latency/Cost）
- **ロール**：管理者、閲覧（分析のみ）
- **運用手順**：週次レポート（未解決質問、人気質問、リンク CTR、コスト）

---

## 16. 受け入れ基準（MVP）

- プラットフォーム/ウィジェット両モードで**引用リンク付き回答**がストリーミング表示
- 埋め込み先サイト内のみで解決できる質問に対し**横断検索なし**で完結
- 見つからない場合、**横断検索に自動フェイルオーバー**
- 初回質問候補・次の質問候補が表示
- 管理画面で**質問一覧/詳細/エクスポート**が可能
- 画像入力が可能（最低 1 枚、代表製品候補提示）

---

## 17. 開発マイルストーン（目安）

1. 週 1–2：設計・骨格（データモデル、プロンプト方針、ウィジェット SDK 仕様）
2. 週 2-3：検索統合（Perplexity）＋引用整形、ストリーミング UI
3. 週 3：ウィジェット β（サイト優先ロジック、テーマ適用）
4. 週 4：管理画面（一覧/詳細/エクスポート）
5. 週 4：画像入力・意図分類精度改善、キャッシュ導入
6. 週 5：QA 候補生成、負荷/セキュリティテスト、受け入れ

---

## 18. 将来拡張

- 公式ドキュメントの**自前インデックス**（ベクトル DB）で更なる精度向上
- SSO（Google Workspace）
- サイトごとの**回答トーン**・CTA 制御（問い合わせ誘導、資料 DL）
- 音声入出力、LINE/Teams 連携、AB テストダッシュボード

---

## 付録 A：ウィジェット埋め込み（例・案）

```html
<script
  src="https://cdn.takasho.ai/assistant.js"
  data-site="https://example.takasho.co.jp"
  data-theme="dark"
  data-color="#0ea5e9"
  defer
></script>
```

---
